rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función para obtener los datos del usuario actual
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Función para verificar si el usuario es administrador
    function isAdmin() {
      return request.auth != null && 
        getUserData().role == 'admin';
    }

    // Función para verificar si el usuario es un trabajador (staff)
    function isStaff() {
      return request.auth != null && 
        (getUserData().role == 'admin' || getUserData().role == 'user');
    }

    // Función para verificar si el usuario está autenticado
    function isAuth() {
      return request.auth != null;
    }

    // Colección de Usuarios
    match /users/{userId} {
      allow read, write: if isAuth() && (request.auth.uid == userId || isAdmin());
    }

    // Colecciones de administración e inventario
    match /productos/{producto} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /establishments/{establishment} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    match /marcas/{marca} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    match /medidas/{medida} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    match /categorias/{categoria} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    
    match /customers/{customerId} {
      // El cliente puede ver y editar su propio registro de cliente (vinculado por UID)
      allow read, write: if isAuth() && (request.auth.uid == customerId || isAdmin());
      // Solo permitir creación a usuarios autenticados (el wizard asegura esto tras el SMS)
      allow create: if isAuth();
      allow update, delete: if isAdmin() || (isAuth() && request.auth.uid == customerId);
    }

    match /sales/{sale} {
      allow read, write: if isAdmin();
    }
    match /settings/{setting} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    match /config/{document} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    match /my_products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Colección de Recetas, Lotes de Pollo y Escenarios
    match /recipes/{recipe} {
      allow read: if true; // Público para la tienda
      allow write: if isAdmin();
    }
    match /chicken_batches/{batch} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /scenarios/{scenario} {
      // Público si está publicado, o si el usuario está autenticado
      allow read: if (resource.data.published == true) || isAuth();
      allow write: if isAdmin();
    }
    
    // Colección de Órdenes (Compras)
    match /orders/{orderId} {
      // El admin ve todo, el cliente solo las suyas
      allow read: if isAdmin() || (isAuth() && resource.data.customer_id == request.auth.uid);
      
      // Solo permitir creación a usuarios autenticados
      allow create: if isAuth();
      
      // Permitir actualización solo al admin o al cliente (solo para subir comprobante)
      allow update: if isAdmin() || (
        isAuth() && 
        resource.data.customer_id == request.auth.uid && 
        request.resource.data.diff(resource.data).affectedKeys().hasAny(['receipt_uploaded', 'receipt_date'])
      );
      
      allow delete: if isAdmin();
    }
  }
}